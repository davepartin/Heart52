<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEART-52</title>
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #1E3A8A;
            background: linear-gradient(135deg, #3B82F6 0%, #10B981 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            letter-spacing: 2px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            font-weight: 400;
            letter-spacing: 0.5px;
            opacity: 0.95;
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.9);
            color: #059669;
            border: 2px solid #6EE7B7;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .nav-btn:hover {
            background: #6EE7B7;
            color: #065F46;
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: #6EE7B7;
            color: #065F46;
            box-shadow: 0 4px 15px rgba(110, 231, 183, 0.3);
        }

        /* Main content area */
        .content {
            background: #FFFFFF;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.1);
        }

        /* Home page styles */
        .verse-list {
            display: grid;
            gap: 15px;
        }

        .verse-item {
            background: linear-gradient(135deg, #E0F2FE 0%, #D1FAE5 100%);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .verse-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.2);
            border-color: #3B82F6;
        }

        .verse-number {
            font-size: 1.2rem;
            font-weight: bold;
            color: #3B82F6;
            margin-bottom: 5px;
            font-family: Arial, sans-serif;
        }

        .verse-reference {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1E3A8A;
            margin-bottom: 8px;
            font-family: Arial, sans-serif;
        }

        .verse-preview {
            color: #1E3A8A;
            opacity: 0.7;
            font-style: italic;
            font-family: Arial, sans-serif;
        }

        /* Week indicator */
        .week-indicator {
            text-align: center;
            margin-bottom: 20px;
            padding: 8px 16px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 20px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            display: inline-block;
            margin: 0 auto 20px auto;
        }

        /* Verse page styles */
        .verse-page {
            text-align: center;
        }

        .verse-display {
            background: linear-gradient(135deg, #E0F2FE 0%, #D1FAE5 100%);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .verse-text {
            font-size: 1.3rem;
            line-height: 1.8;
            margin-bottom: 20px;
            color: #1E3A8A;
            text-align: left;
            font-family: Arial, sans-serif;
        }

        .verse-ref {
            font-size: 1.1rem;
            font-weight: bold;
            color: #3B82F6;
            text-align: left;
            font-family: Arial, sans-serif;
        }

        /* Memory training display - match the verse display exactly */
        .memory-display {
            background: linear-gradient(135deg, #E0F2FE 0%, #D1FAE5 100%);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .memory-text {
            font-size: 1.3rem;
            line-height: 1.8;
            margin-bottom: 20px;
            color: #1E3A8A;
            text-align: left;
            font-family: Arial, sans-serif;
        }

        /* Audio controls */
        .audio-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .audio-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #3B82F6 0%, #1E3A8A 100%);
            color: #FFFFFF;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }

        .audio-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        .audio-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .audio-btn.active {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }

        /* Speed controls */
        .speed-controls {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .speed-heading {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .speed-control-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .speed-label {
            color: #34495e;
            font-weight: 500;
        }

        /* Memory training controls */
        .training-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .level-btn {
            padding: 8px 16px;
            background: #E0F2FE;
            color: #3B82F6;
            border: 2px solid #3B82F6;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .level-btn:hover {
            background: #3B82F6;
            color: #FFFFFF;
        }

        .level-btn.active {
            background: #10B981;
            color: #FFFFFF;
            border-color: #10B981;
        }

        /* Memory training display */
        .memory-text {
            font-size: 1.3rem;
            line-height: 1.8;
            margin-bottom: 20px;
            color: #1E3A8A;
            text-align: left;
            font-family: Arial, sans-serif;
        }

        .blank {
            background: #E0F2FE;
            color: #E0F2FE;
            padding: 2px 8px;
            border-radius: 4px;
            margin: 0 2px;
            border: 2px dashed #3B82F6;
            user-select: none;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .content {
                padding: 20px;
            }

            .verse-text {
                font-size: 1.1rem;
            }

            .audio-controls {
                flex-direction: column;
                align-items: center;
            }

            .audio-btn {
                width: 100%;
                max-width: 200px;
            }

            .nav {
                justify-content: center;
            }

            .training-controls {
                flex-direction: column;
                align-items: center;
            }

            .level-btn {
                width: 100%;
                max-width: 150px;
            }
        }

        /* Hidden class for view switching */
        .hidden {
            display: none !important;
        }

        /* Loading animation */
        .loading {
            text-align: center;
            color: #667eea;
            font-size: 1.1rem;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: '....'; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>HEART-52</h1>
            <p>52 Weeks of Hiding God's Word in Your Heart</p>
        </header>

        <nav class="nav">
            <button class="nav-btn active" onclick="showHome()">Home</button>
        </nav>

        <main class="content">
            <!-- Home View -->
            <div id="home-view">
                <div class="verse-list" id="verse-list">
                    <!-- Verse items will be populated by JavaScript -->
                </div>
            </div>

            <!-- Verse View -->
            <div id="verse-view" class="hidden">
                <div class="verse-page">
                    <div class="week-indicator-simple" id="current-week-indicator">
                        <!-- Week indicator will be populated by JavaScript -->
                    </div>
                    
                    <div class="verse-display">
                        <div class="verse-text" id="current-verse-text"></div>
                        <div class="verse-ref" id="current-verse-ref"></div>
                    </div>

                    <div class="audio-controls">
                        <button class="audio-btn" id="play-once-btn" onclick="playOnce()">
                            🔊 Play Once
                        </button>
                        <button class="audio-btn" id="stop-btn" onclick="stopAudio()">
                            ⏹️ Stop
                        </button>
                        <button class="audio-btn" id="loop-btn" onclick="toggleLoop()">
                            🔁 Loop
                        </button>
                    </div>

                    <div class="speed-controls" id="speed-controls">
                        <!-- Speed control will be added by JavaScript -->
                    </div>

                    <div class="training-controls">
                        <button class="level-btn" onclick="setMemoryLevel(0)">Full Text</button>
                        <button class="level-btn active" onclick="setMemoryLevel(1)">Level 1 (10%)</button>
                        <button class="level-btn" onclick="setMemoryLevel(2)">Level 2 (25%)</button>
                        <button class="level-btn" onclick="setMemoryLevel(3)">Level 3 (50%)</button>
                    </div>

                    <div class="memory-display">
                        <div class="memory-text" id="memory-text"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // HEART-52 Complete Collection - 52 weeks of hiding God's Word in your heart
        const verses = [
            // Foundation: Salvation & Identity (Weeks 1-10)
            {
                reference: "John 3:16",
                text: "For God so loved the world, that he gave his only Son, that whoever believes in him should not perish but have eternal life."
            },
            {
                reference: "Romans 3:23",
                text: "For all have sinned and fall short of the glory of God."
            },
            {
                reference: "Romans 6:23",
                text: "For the wages of sin is death, but the free gift of God is eternal life in Christ Jesus our Lord."
            },
            {
                reference: "Romans 5:8",
                text: "But God shows his love for us in that while we were still sinners, Christ died for us."
            },
            {
                reference: "Romans 10:9",
                text: "Because, if you confess with your mouth that Jesus is Lord and believe in your heart that God raised him from the dead, you will be saved."
            },
            {
                reference: "John 1:12",
                text: "But to all who did receive him, who believed in his name, he gave the right to become children of God."
            },
            {
                reference: "Ephesians 2:8-9",
                text: "For by grace you have been saved through faith. And this is not your own doing; it is the gift of God, not a result of works, so that no one may boast."
            },
            {
                reference: "2 Corinthians 5:17",
                text: "Therefore, if anyone is in Christ, he is a new creation. The old has passed away; behold, the new has come."
            },
            {
                reference: "Romans 8:1",
                text: "There is therefore now no condemnation for those who are in Christ Jesus."
            },
            {
                reference: "Acts 4:12",
                text: "And there is salvation in no one else, for there is no other name under heaven given among men by which we must be saved."
            },
            // Growth: Forgiveness & Transformation (Weeks 11-20)
            {
                reference: "1 John 1:9",
                text: "If we confess our sins, he is faithful and just to forgive us our sins and to cleanse us from all unrighteousness."
            },
            {
                reference: "John 8:32",
                text: "And you will know the truth, and the truth will set you free."
            },
            {
                reference: "Galatians 2:20",
                text: "I have been crucified with Christ. It is no longer I who live, but Christ who lives in me. And the life I now live in the flesh I live by faith in the Son of God, who loved me and gave himself for me."
            },
            {
                reference: "John 14:6",
                text: "Jesus said to him, 'I am the way, and the truth, and the life. No one comes to the Father except through me.'"
            },
            {
                reference: "Romans 1:16",
                text: "For I am not ashamed of the gospel, for it is the power of God for salvation to everyone who believes, to the Jew first and also to the Greek."
            },
            {
                reference: "John 15:5",
                text: "I am the vine; you are the branches. Whoever abides in me and I in him, he it is that bears much fruit, for apart from me you can do nothing."
            },
            {
                reference: "Philippians 1:6",
                text: "And I am sure of this, that he who began a good work in you will bring it to completion at the day of Jesus Christ."
            },
            {
                reference: "1 Corinthians 6:19-20",
                text: "Or do you not know that your body is a temple of the Holy Spirit within you, whom you have from God? You are not your own, for you were bought with a price. So glorify God in your body."
            },
            {
                reference: "Psalm 119:11",
                text: "I have stored up your word in my heart, that I might not sin against you."
            },
            {
                reference: "2 Timothy 3:16-17",
                text: "All Scripture is breathed out by God and profitable for teaching, for reproof, for correction, and for training in righteousness, that the man of God may be complete, equipped for every good work."
            },
            // Strength: Trust & Comfort (Weeks 21-30)
            {
                reference: "Proverbs 3:5-6",
                text: "Trust in the Lord with all your heart, and do not lean on your own understanding. In all your ways acknowledge him, and he will make straight your paths."
            },
            {
                reference: "Philippians 4:13",
                text: "I can do all things through him who strengthens me."
            },
            {
                reference: "Isaiah 40:31",
                text: "But they who wait for the Lord shall renew their strength; they shall mount up with wings like eagles; they shall run and not be weary; they shall walk and not faint."
            },
            {
                reference: "Psalm 23:1",
                text: "The Lord is my shepherd; I shall not want."
            },
            {
                reference: "Psalm 23:4",
                text: "Even though I walk through the valley of the shadow of death, I will fear no evil, for you are with me; your rod and your staff, they comfort me."
            },
            {
                reference: "Psalm 46:1",
                text: "God is our refuge and strength, a very present help in trouble."
            },
            {
                reference: "1 Peter 5:7",
                text: "Casting all your anxieties on him, because he cares for you."
            },
            {
                reference: "Matthew 11:28",
                text: "Come to me, all who labor and are heavy laden, and I will give you rest."
            },
            {
                reference: "Philippians 4:6-7",
                text: "Do not be anxious about anything, but in everything by prayer and supplication with thanksgiving let your requests be made known to God. And the peace of God, which surpasses all understanding, will guard your hearts and your minds in Christ Jesus."
            },
            {
                reference: "Joshua 1:9",
                text: "Have I not commanded you? Be strong and courageous. Do not be frightened, and do not be dismayed, for the Lord your God is with you wherever you go."
            },
            // Living: Character & Action (Weeks 31-40)
            {
                reference: "Matthew 6:33",
                text: "But seek first the kingdom of God and his righteousness, and all these things will be added to you."
            },
            {
                reference: "James 1:5",
                text: "If any of you lacks wisdom, let him ask God, who gives generously to all without reproach, and it will be given him."
            },
            {
                reference: "James 1:22",
                text: "But be doers of the word, and not hearers only, deceiving yourselves."
            },
            {
                reference: "Micah 6:8",
                text: "He has told you, O man, what is good; and what does the Lord require of you but to do justice, and to love kindness, and to walk humbly with your God?"
            },
            {
                reference: "Matthew 22:37-39",
                text: "And he said to him, 'You shall love the Lord your God with all your heart and with all your soul and with all your mind. This is the great and first commandment. And a second is like it: You shall love your neighbor as yourself.'"
            },
            {
                reference: "Galatians 5:22-23",
                text: "But the fruit of the Spirit is love, joy, peace, patience, kindness, goodness, faithfulness, gentleness, self-control; against such things there is no law."
            },
            {
                reference: "Ephesians 4:32",
                text: "Be kind to one another, tenderhearted, forgiving one another, as God in Christ forgave you."
            },
            {
                reference: "1 John 4:7",
                text: "Beloved, let us love one another, for love is from God, and whoever loves has been born of God and knows God."
            },
            {
                reference: "Colossians 3:23",
                text: "Whatever you do, work heartily, as for the Lord and not for men."
            },
            {
                reference: "Matthew 5:16",
                text: "In the same way, let your light shine before others, so that they may see your good works and give glory to your Father who is in heaven."
            },
            // Victory: Purpose & Eternity (Weeks 41-52)
            {
                reference: "Matthew 28:19-20",
                text: "Go therefore and make disciples of all nations, baptizing them in the name of the Father and of the Son and of the Holy Spirit, teaching them to observe all that I have commanded you. And behold, I am with you always, to the end of the age."
            },
            {
                reference: "Acts 1:8",
                text: "But you will receive power when the Holy Spirit has come upon you, and you will be my witnesses in Jerusalem and in all Judea and Samaria, and to the end of the earth."
            },
            {
                reference: "Hebrews 4:12",
                text: "For the word of God is living and active, sharper than any two-edged sword, piercing to the division of soul and of spirit, of joints and of marrow, and discerning the thoughts and intentions of the heart."
            },
            {
                reference: "Colossians 3:16",
                text: "Let the word of Christ dwell in you richly, teaching and admonishing one another in all wisdom, singing psalms and hymns and spiritual songs, with thankfulness in your hearts to God."
            },
            {
                reference: "1 Thessalonians 5:16-18",
                text: "Rejoice always, pray without ceasing, give thanks in all circumstances; for this is the will of God in Christ Jesus for you."
            },
            {
                reference: "2 Corinthians 12:9",
                text: "But he said to me, 'My grace is sufficient for you, for my power is made perfect in weakness.' Therefore I will boast all the more gladly of my weaknesses, so that the power of Christ may rest upon me."
            },
            {
                reference: "Hebrews 11:1",
                text: "Now faith is the assurance of things hoped for, the conviction of things not seen."
            },
            {
                reference: "Hebrews 12:1-2",
                text: "Therefore, since we are surrounded by so great a cloud of witnesses, let us also lay aside every weight, and sin which clings so closely, and let us run with endurance the race that is set before us, looking to Jesus, the founder and perfecter of our faith, who for the joy that was set before him endured the cross, despising the shame, and is seated at the right hand of the throne of God."
            },
            {
                reference: "John 16:33",
                text: "I have said these things to you, that in me you may have peace. In the world you will have tribulation. But take heart; I have overcome the world."
            },
            {
                reference: "Isaiah 53:5",
                text: "But he was pierced for our transgressions; he was crushed for our iniquities; upon him was the chastisement that brought us peace, and with his wounds we are healed."
            },
            {
                reference: "Hebrews 13:5",
                text: "Keep your life free from love of money, and be content with what you have, for he has said, 'I will never leave you nor forsake you.'"
            },
            {
                reference: "Revelation 3:20",
                text: "Behold, I stand at the door and knock. If anyone hears my voice and opens the door, I will come in to him and eat with him, and he with me."
            }
        ];

        // Global variables
        let currentVerse = null;
        let currentMemoryLevel = 1;
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let isLooping = false;
        let speechRate = 1.0; // Normal speed for Google UK English Male

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            populateVerseList();
            showHome();
            addAudioControls();
            
            // Initialize voices when they're available
            if (speechSynthesis.getVoices().length === 0) {
                speechSynthesis.addEventListener('voiceschanged', () => {
                    console.log('Voices loaded');
                });
            }
        }

        // Populate the home page verse list
        function populateVerseList() {
            const verseList = document.getElementById('verse-list');
            verseList.innerHTML = '';

            verses.forEach((verse, index) => {
                const verseItem = document.createElement('div');
                verseItem.className = 'verse-item';
                verseItem.onclick = () => showVerse(index);

                const firstThreeWords = verse.text.split(' ').slice(0, 3).join(' ') + '...';

                verseItem.innerHTML = `
                    <div class="verse-number">Week ${index + 1}</div>
                    <div class="verse-reference">${verse.reference}</div>
                    <div class="verse-preview">${firstThreeWords}</div>
                `;

                verseList.appendChild(verseItem);
            });
        }

        // Navigation functions
        function showHome() {
            document.getElementById('home-view').classList.remove('hidden');
            document.getElementById('verse-view').classList.add('hidden');
            updateNavigation('home');
            stopAudio();
        }

        function showVerse(index) {
            currentVerse = verses[index];
            document.getElementById('home-view').classList.add('hidden');
            document.getElementById('verse-view').classList.remove('hidden');
            updateNavigation('verse');
            displayVerse();
            updateMemoryText();
        }

        function updateNavigation(activeView) {
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => btn.classList.remove('active'));

            // Update navigation based on current view
            if (activeView === 'home') {
                navButtons[0].classList.add('active');
            }
        }

        // Display current verse
        function displayVerse() {
            if (!currentVerse) return;

            document.getElementById('current-verse-text').textContent = currentVerse.text;
            document.getElementById('current-verse-ref').textContent = currentVerse.reference;
            
            // Update week indicator with direct styling
            const weekIndicator = document.getElementById('current-week-indicator');
            const weekNumber = verses.indexOf(currentVerse) + 1;
            weekIndicator.textContent = `Week ${weekNumber}`;
            
            // Apply styling directly via JavaScript
            weekIndicator.style.fontSize = '1.5rem';
            weekIndicator.style.fontWeight = 'bold';
            weekIndicator.style.color = '#93C5FD';
            weekIndicator.style.opacity = '0.8';
            weekIndicator.style.fontFamily = 'Arial, sans-serif';
            weekIndicator.style.textAlign = 'center';
            weekIndicator.style.marginBottom = '20px';
            weekIndicator.style.background = 'none';
            weekIndicator.style.border = 'none';
            weekIndicator.style.padding = '0';
        }

        // Audio functions - force Google UK English Male
        function playOnce() {
            if (!currentVerse) return;

            stopAudio();
            
            // Get voices and force reload if needed
            let voices = speechSynthesis.getVoices();
            if (voices.length === 0) {
                speechSynthesis.addEventListener('voiceschanged', () => {
                    voices = speechSynthesis.getVoices();
                    playOnceWithVoices(voices);
                });
                return;
            }
            
            playOnceWithVoices(voices);
        }

        function playOnceWithVoices(voices) {
            console.log('All available voices:');
            voices.forEach((voice, index) => {
                console.log(`${index}: ${voice.name} (${voice.lang})`);
            });
            
            // Mobile vs Desktop voice selection - prioritize Daniel (en-GB)
            let selectedVoice = null;
            
            // Check if we're on mobile (detect by available voices)
            const hasGoogleVoices = voices.some(voice => voice.name.includes('Google'));
            const hasMobileVoices = voices.some(voice => 
                voice.name.includes('Samantha') || 
                voice.name.includes('Alex') || 
                voice.name.includes('Fred') ||
                voice.name.includes('Daniel')
            );
            
            if (hasMobileVoices) {
                console.log('📱 Mobile device detected - using mobile voices');
                
                // Prioritize Daniel (en-GB) for mobile
                const mobileVoices = [
                    'Daniel (en-GB)',          // Top choice - British English Daniel
                    'Daniel (Enhanced)',       // Enhanced version fallback
                    'Daniel',                  // Standard Daniel
                    'Oliver (en-GB)',          // British Oliver
                    'Oliver',                  // Standard Oliver
                    'Alex',                    // Excellent US male voice
                    'Tom'                      // High-quality US male
                ];
                
                for (const voiceName of mobileVoices) {
                    selectedVoice = voices.find(voice => 
                        voice.name === voiceName || 
                        voice.name.includes(voiceName) ||
                        (voice.name.includes('Daniel') && voice.name.includes('en-GB'))
                    );
                    if (selectedVoice) {
                        console.log('✅ Found mobile voice:', selectedVoice.name);
                        break;
                    }
                }
            } else {
                console.log('🖥️ Desktop device detected - using Google voices');
                
                // Desktop Google voices
                const desktopVoices = [
                    'Google UK English Male',
                    'Google US English',
                    'Microsoft David - English (United States)'
                ];
                
                for (const voiceName of desktopVoices) {
                    selectedVoice = voices.find(voice => voice.name === voiceName);
                    if (selectedVoice) {
                        console.log('✅ Found desktop voice:', selectedVoice.name);
                        break;
                    }
                }
            }
            
            // Final fallback - find any decent English voice
            if (!selectedVoice) {
                console.log('⚠️ No preferred voices found, looking for alternatives...');
                
                // Avoid obviously bad voices
                const avoidVoices = ['Karen', 'Princess', 'Bad News', 'Bells', 'Boing'];
                
                selectedVoice = voices.find(voice => 
                    voice.lang.startsWith('en') && 
                    !avoidVoices.some(badVoice => voice.name.includes(badVoice))
                );
                
                console.log('🔄 Using fallback voice:', selectedVoice?.name || 'Default');
            }
            
            // Create and play utterance
            const fullText = formatTextForSpeech(currentVerse.text) + '. ' + currentVerse.reference + '.';
            currentUtterance = new SpeechSynthesisUtterance(fullText);
            
            if (selectedVoice) {
                currentUtterance.voice = selectedVoice;
                console.log('🎵 Play Once using voice:', selectedVoice.name);
            }
            
            currentUtterance.rate = speechRate;
            currentUtterance.pitch = 1.0;
            currentUtterance.volume = 1;

            updateAudioButtons('playing');
            
            currentUtterance.onend = () => {
                updateAudioButtons('stopped');
            };
            
            currentUtterance.onerror = (event) => {
                console.log('Speech error:', event.error);
                updateAudioButtons('stopped');
            };

            speechSynthesis.speak(currentUtterance);
        }

        function startPlayback(voices, isLoop) {
            if (!currentVerse) return;
            
            const googleUKMaleVoice = voices.find(voice => voice.name === 'Google UK English Male');
            
            // Create text with verse and reference
            const fullText = formatTextForSpeech(currentVerse.text) + '. ' + currentVerse.reference + '.';
            currentUtterance = new SpeechSynthesisUtterance(fullText);
            
            if (googleUKMaleVoice) {
                currentUtterance.voice = googleUKMaleVoice;
                console.log('Using Google UK English Male voice');
            } else {
                console.log('Google UK English Male not found, available voices:', voices.map(v => v.name));
            }
            
            // Optimized settings
            currentUtterance.rate = speechRate;
            currentUtterance.pitch = 1.0;
            currentUtterance.volume = 1;

            if (!isLoop) {
                updateAudioButtons('playing');
                currentUtterance.onend = () => {
                    updateAudioButtons('stopped');
                };
            } else {
                currentUtterance.onend = () => {
                    if (isLooping) {
                        setTimeout(() => {
                            if (isLooping) playLoop();
                        }, 1000); // 1 second pause between loops
                    }
                };
            }
            
            currentUtterance.onerror = (event) => {
                console.log('Speech synthesis error details:', event.error);
                if (!isLoop) {
                    updateAudioButtons('stopped');
                }
            };

            try {
                speechSynthesis.speak(currentUtterance);
            } catch (error) {
                console.log('Speech synthesis failed:', error);
                if (!isLoop) {
                    updateAudioButtons('stopped');
                }
            }
        }

        function playLoop() {
            if (!isLooping || !currentVerse) return;

            // Use same voice selection as playOnce - get voices first
            const voices = speechSynthesis.getVoices();
            let selectedVoice = null;
            
            // Check if we're on mobile (same logic as playOnce)
            const hasMobileVoices = voices.some(voice => 
                voice.name.includes('Samantha') || 
                voice.name.includes('Alex') || 
                voice.name.includes('Fred') ||
                voice.name.includes('Daniel')
            );
            
            if (hasMobileVoices) {
                // Same mobile voice priority as playOnce
                const mobileVoices = [
                    'Daniel (en-GB)',          // Top choice - British English Daniel
                    'Daniel (Enhanced)',       // Enhanced version fallback
                    'Daniel',                  // Standard Daniel
                    'Oliver (en-GB)',          // British Oliver
                    'Oliver',                  // Standard Oliver
                    'Alex',                    // Excellent US male voice
                    'Tom',                     // High-quality US male
                    'Siri Voice 5 (Enhanced)' // Premium Siri fallback
                ];
                
                for (const voiceName of mobileVoices) {
                    selectedVoice = voices.find(voice => 
                        voice.name === voiceName || 
                        voice.name.includes(voiceName) ||
                        (voice.name.includes('Daniel') && voice.name.includes('en-GB'))
                    );
                    if (selectedVoice) {
                        console.log('🔁 Loop using mobile voice:', selectedVoice.name);
                        break;
                    }
                }
            } else {
                // Desktop voice selection
                const desktopVoices = [
                    'Google UK English Male',
                    'Google US English',
                    'Microsoft David - English (United States)'
                ];
                
                for (const voiceName of desktopVoices) {
                    selectedVoice = voices.find(voice => voice.name === voiceName);
                    if (selectedVoice) {
                        console.log('🔁 Loop using desktop voice:', selectedVoice.name);
                        break;
                    }
                }
            }
            
            // Fallback
            if (!selectedVoice) {
                const avoidVoices = ['Karen', 'Princess', 'Bad News', 'Bells', 'Boing'];
                selectedVoice = voices.find(voice => 
                    voice.lang.startsWith('en') && 
                    !avoidVoices.some(badVoice => voice.name.includes(badVoice))
                );
                console.log('🔁 Loop using fallback voice:', selectedVoice?.name || 'Default');
            }
            
            const fullText = formatTextForSpeech(currentVerse.text) + '. ' + currentVerse.reference + '.';
            currentUtterance = new SpeechSynthesisUtterance(fullText);
            
            if (selectedVoice) {
                currentUtterance.voice = selectedVoice;
            }
            
            currentUtterance.rate = speechRate;
            currentUtterance.pitch = 1.0;
            currentUtterance.volume = 1;

            currentUtterance.onend = () => {
                if (isLooping) {
                    setTimeout(() => {
                        if (isLooping) playLoop();
                    }, 1000);
                }
            };
            
            currentUtterance.onerror = (event) => {
                console.log('Speech synthesis loop error:', event.error);
                if (isLooping) {
                    setTimeout(() => {
                        if (isLooping) playLoop();
                    }, 1000);
                }
            };

            speechSynthesis.speak(currentUtterance);
        }

        function toggleLoop() {
            if (isLooping) {
                stopAudio();
            } else {
                startLoop();
            }
        }

        function startLoop() {
            if (!currentVerse) return;

            isLooping = true;
            updateAudioButtons('looping');
            playLoop();
        }

        function stopAudio() {
            speechSynthesis.cancel();
            isLooping = false;
            currentUtterance = null;
            updateAudioButtons('stopped');
        }

        function updateAudioButtons(state) {
            const playBtn = document.getElementById('play-once-btn');
            const loopBtn = document.getElementById('loop-btn');
            const stopBtn = document.getElementById('stop-btn');

            // Reset all buttons
            playBtn.classList.remove('active');
            loopBtn.classList.remove('active');
            playBtn.disabled = false;
            loopBtn.disabled = false;
            stopBtn.disabled = false;

            switch(state) {
                case 'playing':
                    playBtn.classList.add('active');
                    playBtn.disabled = true;
                    break;
                case 'looping':
                    loopBtn.classList.add('active');
                    loopBtn.textContent = '⏸️ Stop Loop';
                    playBtn.disabled = true;
                    break;
                case 'stopped':
                    loopBtn.textContent = '🔁 Loop';
                    break;
            }
        }

        // Memory training functions
        function setMemoryLevel(level) {
            currentMemoryLevel = level;
            updateMemoryLevelButtons();
            updateMemoryText();
        }

        function updateMemoryLevelButtons() {
            const levelButtons = document.querySelectorAll('.level-btn');
            levelButtons.forEach((btn, index) => {
                btn.classList.toggle('active', index === currentMemoryLevel);
            });
        }

        function updateMemoryText() {
            if (!currentVerse) return;

            const memoryTextElement = document.getElementById('memory-text');
            let displayText = currentVerse.text;

            if (currentMemoryLevel > 0) {
                displayText = createMemoryText(currentVerse.text, currentMemoryLevel);
            }

            memoryTextElement.innerHTML = displayText;
        }

        function createMemoryText(text, level) {
            const words = text.split(' ');
            let removalPercentage;

            switch(level) {
                case 1: removalPercentage = 0.1; break;  // 10%
                case 2: removalPercentage = 0.25; break; // 25%
                case 3: removalPercentage = 0.5; break;  // 50%
                default: return text;
            }

            const wordsToRemove = Math.floor(words.length * removalPercentage);
            const indicesToRemove = new Set();

            // Randomly select indices to remove
            while (indicesToRemove.size < wordsToRemove) {
                const randomIndex = Math.floor(Math.random() * words.length);
                indicesToRemove.add(randomIndex);
            }

            // Create the display text with blanks
            return words.map((word, index) => {
                if (indicesToRemove.has(index)) {
                    return `<span class="blank">${'_'.repeat(Math.max(3, word.length))}</span>`;
                }
                return word;
            }).join(' ');
        }

        // Format text for better speech synthesis
        function formatTextForSpeech(text) {
            return text
                // Add pauses after commas and semicolons
                .replace(/,/g, ', ')
                .replace(/;/g, '; ')
                // Add longer pauses after periods
                .replace(/\./g, '. ')
                // Handle common Bible abbreviations
                .replace(/\bvs?\.\s/gi, 'verse ')
                .replace(/\bch\.\s/gi, 'chapter ')
                .replace(/\bPs\.\s/gi, 'Psalm ')
                .replace(/\bMt\.\s/gi, 'Matthew ')
                .replace(/\bMk\.\s/gi, 'Mark ')
                .replace(/\bLk\.\s/gi, 'Luke ')
                .replace(/\bJn\.\s/gi, 'John ')
                // Handle numbers with colons (verse references)
                .replace(/(\d+):(\d+)/g, '$1 verse $2');
        }

        // Add audio controls for speed adjustment
        function addAudioControls() {
            const speedControls = document.getElementById('speed-controls');
            
            // Speed control without the heading
            speedControls.innerHTML = `
                <div class="speed-control-row">
                    <label for="speed-slider" class="speed-label">Speed:</label>
                    <input type="range" id="speed-slider" min="0.5" max="1.5" step="0.1" value="1.0" 
                           onchange="updateSpeechSpeed(this.value)">
                    <span id="speed-display" class="speed-display">1.0x</span>
                </div>
            `;
        }

        function updateSpeechSpeed(rate) {
            speechRate = parseFloat(rate);
            document.getElementById('speed-display').textContent = rate + 'x';
        }

        // Handle browser back button
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.view === 'verse') {
                // Handle back to verse view if needed
            } else {
                showHome();
            }
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (document.getElementById('verse-view').classList.contains('hidden')) return;

            switch(event.key) {
                case ' ':
                    event.preventDefault();
                    playOnce();
                    break;
                case 'l':
                    event.preventDefault();
                    toggleLoop();
                    break;
                case 's':
                    event.preventDefault();
                    stopAudio();
                    break;
                case '1':
                    event.preventDefault();
                    setMemoryLevel(1);
                    break;
                case '2':
                    event.preventDefault();
                    setMemoryLevel(2);
                    break;
                case '3':
                    event.preventDefault();
                    setMemoryLevel(3);
                    break;
                case '0':
                    event.preventDefault();
                    setMemoryLevel(0);
                    break;
                case 'Escape':
                    showHome();
                    break;
            }
        });
    </script>
</body>
</html>